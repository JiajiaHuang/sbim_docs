name: åŒæ­¥æ–‡æ¡£å¹¶è§¦å‘ç½‘ç«™æ›´æ–°

on:
  push:
    branches: [ main ]
    paths:
      - '**'
  workflow_dispatch:

jobs:
  sync-docs-and-trigger-update:
    runs-on: ubuntu-latest
    steps:
      - name: æ£€å‡ºæ–‡æ¡£ä»“åº“
        uses: actions/checkout@v4
        with:
          path: sbim_docs

      - name: æ£€å‡ºç½‘ç«™ä»“åº“
        uses: actions/checkout@v4
        with:
          repository: JiajiaHuang/sbim_web
          token: ${{ secrets.PERSONAL_ACCESS_TOKEN }}
          path: sbim_web

      - name: åŒæ­¥æ–‡æ¡£å†…å®¹åˆ°ç½‘ç«™ä»“åº“
        run: |
          echo "ğŸ”„ å¼€å§‹åŒæ­¥æ–‡æ¡£å†…å®¹..."
          
          # æ£€æŸ¥æ–‡æ¡£ä»“åº“ç»“æ„
          echo "ğŸ“‚ æ–‡æ¡£ä»“åº“ç»“æ„:"
          ls -la sbim_docs/
          
          # ç¡®ä¿ç½‘ç«™ä»“åº“çš„ docs ç›®å½•å­˜åœ¨
          mkdir -p sbim_web/docs
          
          # æ¸…ç©ºç½‘ç«™ä»“åº“çš„ docs ç›®å½•
          rm -rf sbim_web/docs/*
          
          # å¤åˆ¶æ–‡æ¡£ä»“åº“çš„å†…å®¹åˆ°ç½‘ç«™ä»“åº“
          if [ -d "sbim_docs/docs" ]; then
            cp -r sbim_docs/docs/* sbim_web/docs/
            echo "âœ… å·²å¤åˆ¶ docs ç›®å½•"
          else
            echo "âš ï¸ æ–‡æ¡£ä»“åº“ä¸­æ²¡æœ‰ docs ç›®å½•"
          fi
          
          if [ -d "sbim_docs/api" ]; then
            mkdir -p sbim_web/docs/api
            cp -r sbim_docs/api/* sbim_web/docs/api/
            echo "âœ… å·²å¤åˆ¶ api ç›®å½•"
          else
            echo "âš ï¸ æ–‡æ¡£ä»“åº“ä¸­æ²¡æœ‰ api ç›®å½•"
          fi
          
          echo "ğŸ“ åŒæ­¥åçš„æ–‡ä»¶åˆ—è¡¨:"
          find sbim_web/docs -name "*.md" | head -10

      - name: è‡ªåŠ¨ç”Ÿæˆ sidebars.ts é…ç½®
        run: |
          echo "ğŸ”§ å¼€å§‹ç”Ÿæˆ sidebars.ts é…ç½®..."
          
          cd sbim_web
          
          # åˆ›å»º Node.js è„šæœ¬æ¥ç”Ÿæˆ sidebars.ts
          cat > generate_sidebars.js << 'SCRIPT_EOF'
          const fs = require('fs');
          const path = require('path');
          
          function getAllMdFiles(dir, basePath = '') {
            const files = [];
            const fullPath = path.join('docs', dir);
            
            if (!fs.existsSync(fullPath)) return files;
            
            const entries = fs.readdirSync(fullPath, { withFileTypes: true });
            
            entries.forEach(entry => {
              if (entry.isFile() && entry.name.endsWith('.md')) {
                const fileName = entry.name.replace('.md', '');
                const docId = basePath ? basePath + '/' + fileName : fileName;
                files.push(docId);
              } else if (entry.isDirectory()) {
                const subPath = basePath ? basePath + '/' + entry.name : entry.name;
                files.push(...getAllMdFiles(path.join(dir, entry.name), subPath));
              }
            });
            
            return files;
          }
          
          // è·å–æ‰€æœ‰æ–‡æ¡£æ–‡ä»¶
          const allDocs = getAllMdFiles('');
          
          // ç”Ÿæˆ sidebars.ts å†…å®¹
          const sidebarItems = allDocs.map(doc => "    '" + doc + "'").join(',\n');
          
          const sidebarContent = "import type {SidebarsConfig} from '@docusaurus/plugin-content-docs';\n\n" +
            "const sidebars: SidebarsConfig = {\n" +
            "  tutorialSidebar: [\n" +
            sidebarItems + "\n" +
            "  ],\n" +
            "};\n\n" +
            "export default sidebars;\n";
          
          fs.writeFileSync('sidebars.ts', sidebarContent);
          console.log('âœ… sidebars.ts å·²ç”Ÿæˆï¼ŒåŒ…å«', allDocs.length, 'ä¸ªæ–‡æ¡£');
          console.log('æ–‡æ¡£åˆ—è¡¨:', allDocs.join(', '));
          SCRIPT_EOF
          
          # è¿è¡Œè„šæœ¬ç”Ÿæˆ sidebars.ts
          node generate_sidebars.js
          
          # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
          rm generate_sidebars.js
          
          echo "ğŸ“„ ç”Ÿæˆçš„ sidebars.ts å†…å®¹:"
          cat sidebars.ts

      - name: é…ç½® Git ç”¨æˆ·ä¿¡æ¯
        run: |
          cd sbim_web
          git config user.name "Jiaheng"
          git config user.email "569249477@qq.com"

      - name: æäº¤æ–‡æ¡£æ›´æ–°åˆ°ç½‘ç«™ä»“åº“
        run: |
          cd sbim_web
          git add docs/ sidebars.ts
          
          if git diff --staged --quiet; then
            echo "ğŸ“ æ²¡æœ‰æ–‡æ¡£å†…å®¹å˜åŒ–ï¼Œè·³è¿‡æäº¤"
          else
            git commit -m "docs: è‡ªåŠ¨åŒæ­¥æ–‡æ¡£å†…å®¹å¹¶æ›´æ–°ä¾§è¾¹æ é…ç½®

          æ¥æºæäº¤: ${{ github.repository }}@${{ github.sha }}
          æäº¤è€…: ${{ github.actor }}
          åŒæ­¥æ—¶é—´: $(date -u '+%Y-%m-%d %H:%M:%S UTC')

          æ›´æ–°å†…å®¹:
          - è‡ªåŠ¨ä»æ–‡æ¡£ä»“åº“åŒæ­¥æœ€æ–°å†…å®¹åˆ°ç½‘ç«™ä»“åº“
          - æ ¹æ®å®é™…æ–‡æ¡£ç»“æ„è‡ªåŠ¨ç”Ÿæˆ sidebars.ts é…ç½®
          - ç¡®ä¿ä¾§è¾¹æ ä¸æ–‡æ¡£å†…å®¹å®Œå…¨åŒ¹é…"
            
            git push origin main
            echo "âœ… æ–‡æ¡£å†…å®¹å’Œé…ç½®å·²åŒæ­¥åˆ°ç½‘ç«™ä»“åº“"
          fi

      - name: è®°å½•åŒæ­¥ä¿¡æ¯
        run: |
          echo "âœ… æ–‡æ¡£åŒæ­¥å®Œæˆ"
          echo "ğŸ“ æ–‡æ¡£ä»“åº“æäº¤: ${{ github.sha }}"
          echo "ğŸ‘¤ æäº¤è€…: ${{ github.actor }}"
          echo "ğŸŒ¿ åˆ†æ”¯: ${{ github.ref }}"
          echo "ğŸŒ ç½‘ç«™å°†è‡ªåŠ¨é‡æ–°éƒ¨ç½²"
